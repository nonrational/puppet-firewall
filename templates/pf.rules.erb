# GENERATED BY BOXEN
# Inspired by http://blog.scottlowe.org/2013/05/15/using-pf-on-os-x-mountain-lion/

# Options
set block-policy drop
set fingerprints "/etc/pf.os"
set ruleset-optimization basic
set skip on lo0

scrub in all no-df
antispoof log quick for { lo0 en0 en2 }

block in log
block in log quick from no-route to any

pass quick proto icmp all

<% scope.lookupvar('allow_inbound_ports').each do |port| -%>
pass in quick proto { tcp udp } from any to any port { <%= port %> }
<% end -%>

# [X] 53    DNS
# [X] 67    DHCP
# [X] 68    DHCP
# [X] 123   NTP
# [ ] 389   LDAP
# [ ] 636   LDAPS
# [X] 5353  mDNS
# [X] 5354  mDNS (?)
basic_services = "any port { 53 67 68 123 5353 5354 } flags S/SA keep state"
# The range 49152–65535 (215+214 to 216−1) contains dynamic or private ports that cannot be registered with IANA
dynamic_ports  = "any port { 49152:65535 } flags S/SA keep state"

pass in proto {tcp, udp} from { 192.168.0.0/16 } to $basic_services
pass in proto {tcp, udp} from { 10.0.0.0/8     } to $basic_services
pass in proto {tcp, udp} from { 172.16.0.0/12  } to $basic_services
pass in proto {tcp, udp} from { fe80::/10      } to $basic_services

pass in proto {tcp, udp} from { 192.168.0.0/16 } to $dynamic_ports
pass in proto {tcp, udp} from { 10.0.0.0/8     } to $dynamic_ports
pass in proto {tcp, udp} from { 172.16.0.0/12  } to $dynamic_ports
pass in proto {tcp, udp} from { fe80::/10      } to $dynamic_ports

# Allow outgoing traffic
pass out inet proto tcp from any to any keep state
pass out inet proto udp from any to any keep state
